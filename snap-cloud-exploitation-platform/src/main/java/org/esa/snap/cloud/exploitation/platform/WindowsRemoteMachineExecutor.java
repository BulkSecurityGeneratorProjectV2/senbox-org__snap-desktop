package org.esa.snap.cloud.exploitation.platform;

import com.jcraft.jsch.JSchException;
import com.jcraft.jsch.Session;
import com.jcraft.jsch.SftpException;
import org.esa.snap.core.gpf.graph.GraphException;

import java.io.IOException;
import java.util.logging.Level;

/**
 * Created by jcoravu on 22/1/2019.
 */
public class WindowsRemoteMachineExecutor extends AbstractRemoteMachineExecutor {

    public WindowsRemoteMachineExecutor(String sharedFolderURL, String sharedFolderUsername, String sharedFolderPassword, ServerCredentials serverCredentials, RemoteMachinesGraphHelper remoteMachinesGraphHelper) {
        super(sharedFolderURL, sharedFolderUsername, sharedFolderPassword, serverCredentials, remoteMachinesGraphHelper);
    }

    @Override
    protected OutputConsoleBuffer runGraph(Session session, char fileSeparator, String remoteMachineSharedFolder, String graphRelativeFilePath) throws IOException, JSchException {
        String command = buildRunGPTCommand(fileSeparator, remoteMachineSharedFolder, graphRelativeFilePath);
        OutputConsoleBuffer consoleBuffer = new OutputConsoleBuffer();
        int exitStatus = SSHConnection.executeWindowsCommand(session, command, consoleBuffer);

        logger.log(Level.FINE, buildLogMessage(command, consoleBuffer, exitStatus));

        return consoleBuffer;
    }

    @Override
    protected void execute(Session session) throws IOException, GraphException, SftpException, JSchException {
        String command = buildMountSharedDriveCommand(this.masterSharedFolderPassword);
        OutputConsoleBuffer consoleBuffer = new OutputConsoleBuffer();
        int exitStatus = SSHConnection.executeWindowsCommand(session, command, consoleBuffer);

        command = buildMountSharedDriveCommand("..."); // do not write the password in the log file
        logger.log(Level.FINE, buildLogMessage(command, consoleBuffer, exitStatus));

        String valuesToCheck[] = new String[] {"System error", "has occurred", "password is not correct"};
        if (consoleBuffer.containsIgnoreCase(valuesToCheck)) {
            return; // System error 86 has occurred. The specified network password is not correct.
        }
        runGraphs(session, '\\');
    }

    private String buildRunGPTCommand(char fileSeparator, String remoteMachineSharedFolder, String graphRelativeFilePath) {
        StringBuilder command = new StringBuilder();
        command.append("gpt")
                .append(" ")
                .append(normalizePath(remoteMachineSharedFolder))
                .append(fileSeparator)
                .append(normalizePath(graphRelativeFilePath));
        return command.toString();
    }

    private String buildMountSharedDriveCommand(String masterSharedFolderPassword) {
        StringBuilder command = new StringBuilder();
        command.append("net use")
                .append(" ")
                .append(normalizePath(this.remoteMachineCredentials.getSharedFolderPath()))
                .append(" ")
                .append(normalizePath(this.masterSharedFolderURL))
                .append(" ")
                .append(masterSharedFolderPassword)
                .append(" ")
                .append("/user:")
                .append(this.masterSharedFolderUsername)
                .append(" ")
                .append("/persistent:no");
        return command.toString();
    }

    private static String normalizePath(String path) {
        return path.replace('/', '\\');
    }
}
