package org.esa.snap.cloud.exploitation.platform.topology;

import org.apache.commons.lang.SystemUtils;
import org.esa.snap.cloud.exploitation.platform.ServerCredentials;
import org.esa.snap.cloud.exploitation.platform.loading.AbstractModalDialog;
import org.esa.snap.cloud.exploitation.platform.loading.ILoadingIndicator;

import javax.swing.*;
import java.awt.Dimension;
import java.awt.Insets;
import java.awt.Window;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;

/**
 * Created by jcoravu on 17/12/2018.
 */
public class RemoteTopologyDialog extends AbstractModalDialog {

    private RemoteTopologyPanel remoteTopologyPanel;

    public RemoteTopologyDialog(Window parent, String title) {
        super(parent, title, true);
    }

    @Override
    protected final void onAboutToShow() {
        JDialog dialog = getJDialog();
        dialog.setMinimumSize(new Dimension(450, 350));

        ILoadingIndicator loadingIndicator = getLoadingIndicator();
        int threadId = getNewCurrentThreadId();
        ReadRemoteTopologyTimerRunnable runnable = new ReadRemoteTopologyTimerRunnable(this, loadingIndicator, threadId) {
            @Override
            protected void onSuccessfullyFinish(RemoteTopology remoteTopology) {
                onFinishReadingRemoteTopology(remoteTopology);
            }
        };
        Thread thread = new Thread(runnable);
        thread.start(); // start the thread
    }

    @Override
    protected JPanel buildContentPanel(int gapBetweenColumns, int gapBetweenRows) {
        Insets defaultTextFieldMargins = buildDefaultTextFieldMargins();
        Insets defaultListItemMargins = buildDefaultListItemMargins();
        if (SystemUtils.IS_OS_LINUX) {
            this.remoteTopologyPanel = new LinuxRemoteTopologyPanel(getJDialog(), defaultTextFieldMargins, defaultListItemMargins);
        } else if (SystemUtils.IS_OS_WINDOWS) {
            this.remoteTopologyPanel = new WindowsRemoteTopologyPanel(getJDialog(), defaultTextFieldMargins, defaultListItemMargins);
        } else {
            throw new UnsupportedOperationException("Unknown operating system.");
        }
        this.remoteTopologyPanel.addComponents(gapBetweenColumns, gapBetweenRows, true, true);
        return remoteTopologyPanel;
    }

    @Override
    protected JPanel buildButtonsPanel(ActionListener cancelActionListener) {
        ActionListener saveActionListener = new ActionListener() {
            @Override
            public void actionPerformed(ActionEvent event) {
                saveButtonPressed();
            }
        };
        return buildButtonsPanel("Save", saveActionListener, "Cancel", cancelActionListener);
    }

    private void saveButtonPressed() {
        DefaultListModel<ServerCredentials> model = (DefaultListModel<ServerCredentials>)this.remoteTopologyPanel.getRemoteMachinesList().getModel();
        if (model.size() > 0) {
            String remoteSharedFolderURL = this.remoteTopologyPanel.getRemoteSharedFolderURLTextField().getText().trim();
            String remoteUsername = this.remoteTopologyPanel.getRemoteUsernameTextField().getText();
            String remotePassword = new String(this.remoteTopologyPanel.getRemotePasswordTextField().getPassword());

            String localSharedFolderPath = null;
            JTextField localSharedFolderPathTextField = this.remoteTopologyPanel.getLocalSharedFolderPathTextField();
            if (localSharedFolderPathTextField != null) {
                localSharedFolderPath = localSharedFolderPathTextField.getText().trim();
            }

            String localPassword = null;
            JPasswordField localPasswordTextField = this.remoteTopologyPanel.getLocalPasswordTextField();
            if (localPasswordTextField != null) {
                localPassword = new String(localPasswordTextField.getPassword());
            }

            RemoteTopology remoteTopology = new RemoteTopology(remoteSharedFolderURL, remoteUsername, remotePassword);
            remoteTopology.setLocalMachineData(localSharedFolderPath, localPassword);

            for (int i=0; i<model.size(); i++) {
                remoteTopology.addRemoteMachine(model.getElementAt(i));
            }

            ILoadingIndicator loadingIndicator = getLoadingIndicator();
            int threadId = getNewCurrentThreadId();
            WriteRemoteTopologyTimerRunnable runnable = new WriteRemoteTopologyTimerRunnable(this, loadingIndicator, threadId, remoteTopology);
            Thread thread = new Thread(runnable);
            thread.start(); // start the thread
        }
    }

    private void onFinishReadingRemoteTopology(RemoteTopology remoteTopology) {
        if (remoteTopology != null) {
            this.remoteTopologyPanel.setRemoteTopology(remoteTopology);
        }
    }
}
